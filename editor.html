<html>
    <body>
        <main>
            <textarea id="editor" spellcheck="false">#: Neknaj Language For Programming

!include: stdcalc;
!using: stdcalc;

!replace: pi: 3.1415;

#* hey
this

is a block comment *#

!global: 12.str: string; # this is a line comment

!fn: 4.int:(4.int: max): main {

    0 :> !local: 4.int: x;
    !local: 4.int: y <: y;
    !local: 4.int: z;

    !ctrl:(x max <):while {
        y x + :> z;
        y :> x;
        z :> y;
    }

    "hello world" "!\n\"\\" add :> string;
    0 :> return;
}</textarea>
            <div id="highlight"><pre></pre></div>
        </main>
    </body>
</html>

<script src="nlp.js"></script>
<script>

const editor = document.getElementById("editor");
var nlpt;

function makeHighLight(tokenarr) {
    let output = document.getElementById("highlight").childNodes[0];
    output.innerHTML = "";
    //console.log(tokenarr)
    {
        let linen = document.createElement("span");
        linen.classList.add("linenumber");
        linen.innerText = 1;
        output.appendChild(linen);
    }
    for (let token of tokenarr) {
        let span = document.createElement("span");
        output.appendChild(span);
        span.innerText = token.val;
        if (token.type!=-1) {
            span.classList.add(token.type_str.split(".").join("_"));
            if (token.val==" ") {
                span.classList.add(`space`);
            }
        }
        else {
            span.classList.add("Error");
        }
        if (token.val=="\n") {
            span.innerText = "⏎";
            let br = document.createElement("br");
            output.appendChild(br);
            let linen = document.createElement("span");
            linen.classList.add("linenumber");
            linen.innerText = token.line+1;
            output.appendChild(linen);
        }
    }
}
editor.onchange = update;
//editor.onkeydown = update;
editor.oninput = update;

update()
function update() {
    nlpt = new NLPtool(`data:text/plain;charset=UTF-8;base64,${btoa(String.fromCharCode.apply(null, new TextEncoder().encode(editor.value)))}`);
    try {
        nlpt.tokenize();
    }
    catch (e) {
        //console.error(e)
        { // 未解決部分追加
            if (nlpt.tokenarr.length!=0) {
                let lastindex = nlpt.tokenarr[nlpt.tokenarr.length-1].i + nlpt.tokenarr[nlpt.tokenarr.length-1].val.length;
                console.log(lastindex);
                nlpt.tokenarr.push({ type:-1, type_str:"Error", val: nlpt.code.slice(lastindex), i: lastindex })
            }
            else {
                nlpt.tokenarr.push({ type:-1, type_str:"Error", val: nlpt.code, i: 0 })
            }
        }
    }
    try {
        nlpt.parse();
    }
    catch (e) {
        console.error(e)
    }
    //console.log(nlpt.tokenarr)
    makeHighLight(nlpt.tokenarr);
    //console.log(nlpt)
}

</script>
<style>
    body {
        background-color: black;
        height: 100dvh;
        padding: 0;
        margin: 0;
    }
    main {
        display: flex;
        height: 100%;
    }
    #editor {
        width: 100%;
        font-size: 15px;
        background: transparent;
        color: white;
        border: none;
        outline: none;
        resize: none;
        overflow: scroll;
        line-height: 20px;
    }
    #highlight {
        width: calc(100% + 125px);
        font-size: 15px;
        font-family: monospace;
        background-color: rgb(0, 4, 26);
        color: white;
        height: 100dvh;
        overflow: scroll;
        line-height: 18px;
    }
    .linenumber {
        font-size: 10px;
        display: inline-block;
        margin: 0;
        margin-right: 10px;
        padding-left: 10px;
        width: 40px;
        border-right: 1px solid rgb(108, 68, 43);
        background-color: rgb(0, 17, 69);
        user-select: none;
        -webkit-user-select: none;
    }
</style>
<style id="highlight_style">

    #highlight pre {
        margin: 0;
    }

    #highlight span.EOL {
        color: rgb(135, 135, 135);
    }

    .token {
        color: rgb(255, 249, 167);
    }
    .split {
        color: rgb(255, 255, 255);
    }
    .space {
        text-decoration: underline wavy rgba(199, 199, 199, 0.3);
        -webkit-text-decoration: underline wavy rgba(199, 199, 199, 0.3);
    }
    .special {
        color: rgb(92, 168, 255);
    }
    .LF {
        color: gray;
        user-select: none;
        -webkit-user-select: none;
    }
    .comment_LF {
        color: gray;
        user-select: none;
        -webkit-user-select: none;
        text-decoration: underline rgba(55, 186, 92, 0.4);
        -webkit-text-decoration: underline rgba(55, 186, 92, 0.4);
    }
    .comment_start, .comment_blockstart, .comment_blockend1, .comment_blockend, .comment_notestart {
        color: rgb(0, 153, 0);
    }
    .comment_blockcomment, .comment_linecomment {
        color: rgb(49, 123, 87);
        text-decoration: underline rgba(55, 186, 92, 0.4);
        -webkit-text-decoration: underline rgba(55, 186, 92, 0.4);
    }
    .comment_note {
        color: rgb(0, 0, 0);
        background-color: rgb(255, 248, 206);
        text-decoration: underline rgba(0, 242, 69, 0.4);
        -webkit-text-decoration: underline rgba(0, 242, 69, 0.4);
        border-radius: 3px;
        padding: 2px;
    }
    .comment_notebeforeblank {
        text-decoration: underline rgba(0, 242, 69, 0.4);
        -webkit-text-decoration: underline rgba(0, 242, 69, 0.4);
    }

    .string_start, .string_end {
        color: rgb(242, 129, 8);
    }
    .string_char {
        color: rgb(255, 188, 64);
    }
    .string_space {
        text-decoration: underline wavy rgba(255, 115, 0, 0.3);
        -webkit-text-decoration: underline wavy rgba(255, 115, 0, 0.3);
    }
    .string_escape1 {
        color: rgb(181, 154, 21);
    }
    .string_escape2 {
        color: rgb(235, 204, 46);
    }

    .lassign, .lassign_, .rassign, .rassign_ {
        color: red;
    }
</style>